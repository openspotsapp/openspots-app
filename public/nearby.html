<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<title>Find Open Spots Nearby | OpenSpots</title>
  <link rel="icon" type="image/png" href="assets/Facebook Profile Picture.png" />
  <link rel="stylesheet" href="style.css" />
  <link rel="icon" type="image/png" href="assets/favicon.png" />
</head>

<body class="page-bg">

  <!-- HEADER (Dynamic title injected by JS) -->
  <div id="header"></div>
  <div data-page-title="FIND AN OPEN SPOT"></div>

  <!-- MAIN CONTENT -->
  <div class="nearby-container">

    <!-- RADIUS POPUP -->
    <div id="radiusPopup" class="radius-popup" style="display:none;">
      <div class="radius-title">Find spots within:</div>
      <button class="radius-btn" data-radius="5">5 miles</button>
      <button class="radius-btn" data-radius="3">3 miles</button>
      <button class="radius-btn" data-radius="1">1 mile</button>
    </div>

    <!-- RANGE SELECTION POPUP -->
    <div id="rangePopup" class="range-popup" style="display:none;">
      <h3>Select Range</h3>

      <div class="range-option" data-range="5">
        Within 5 miles
      </div>

      <div class="range-option" data-range="3">
        Within 3 miles
      </div>

      <div class="range-option" data-range="1">
        Within 1 mile
      </div>
    </div>

    <!-- GOOGLE MAP -->
    <div id="map" class="nearby-map"></div>

    <div class="legend-login-user">
      <div class="legend-login-user-item">
        <img src="assets/Facebook Profile Picture.png" class="legend-login-user-icon" alt="Available spot">
        Available
      </div>
      <div class="legend-login-user-item">
        <img src="assets/RED MARKER ICON.png" class="legend-login-user-icon" alt="Occupied spot">
        Occupied
      </div>
    </div>

      <div class="nearby-info">
      <h2 id="infoTextUser">Loading Open Spots...</h2>
      </div>

    <div id="infoMicro" class="info-micro">
      <span class="info-icon">‚ÑπÔ∏è</span>
      <span id="infoMicroText"></span>
    </div>

    <!-- INFO CARD -->
    <div id="nearbyPopup" class="nearby-popup" style="display:none;">
      Based on your location, we found nearby spots.
    </div>
    <div id="spotInfo" class="spot-info-card">
    <div class="spot-info-title" id="spotTitle">OPEN SPOT</div>
    <div class="spot-info-details" id="spotDetails">Address, City, Zip Code<br>FREE PARKING - 9AM to 6PM</div>
    <button id="navigateBtn" class="navigate-btn">NAVIGATE</button>
</div>

  </div>


  <!-- NAVIGATION BAR -->
  <div id="navbar"></div>
  <div id="navHint" class="nav-hint">Tap here to find nearby Open Spots</div>

  <!-- Load Header + Navbar -->
  <script src="load-components.js"></script>

  <!-- Google Maps (replace YOUR_KEY with your key) -->
  <script 
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBnNTs3_DlvbUa4bNcZktr_gxdAj_AIZNs&callback=initMap" 
    defer>
  </script>

  <script type="module">
    import { getAuth, onAuthStateChanged } from
      "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";
    import {
      getFirestore,
      collection,
      getDocs,
      doc,
      getDoc
    } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";
    import { app } from "./firebase-init.js";

    const db = getFirestore();

    let map;
    let userMarker;
    let userPulse;
    let selectedMarker = null;
    let selectedPulse = null;
    const AVAILABLE_ICON = "assets/OpenSpot Parking.jpg";
    const OCCUPIED_ICON = "assets/ClosedSpot Parking.jpg";
    const markers = [];
    window.map = null;
    let currentUserLat = null;
    let currentUserLng = null;
    let currentRadiusMiles = null;
    let userLatLng = null;

    const auth = getAuth(app);

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        // Not logged in ‚Üí force login
        window.location.replace("/login.html");
        return;
      }

      try {
        const userDoc = await getDoc(doc(db, "users", user.uid));
        const data = userDoc.data();

        if (!data || data.setupComplete === false) {
          window.location.href = "accSetup.html";
        }
      } catch (err) {
        console.error("Failed to verify setup completion", err);
      }
    });

    document.addEventListener("navbarLoaded", () => {
      const card = document.getElementById("spotInfo");
      if (card) card.style.display = "none";
    });

    const btn = document.getElementById("nearbyButton");

    if (btn) {
      btn.addEventListener("click", function () {
          btn.classList.remove("neon-pulse");
      });
    }

    // ---------- Smart ‚ÄúTake Me Here‚Äù ----------
    function openDirections(lat, lng) {
      const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
      const url = isMobile
        ? `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}&travelmode=driving`
        : `https://maps.google.com/?daddr=${lat},${lng}&travelmode=driving`;
      window.open(url, "_blank");
    }

    function showNavHint() {
      const hint = document.getElementById("navHint");
      if (!hint) return;

      hint.style.display = "block";

      setTimeout(() => {
        hint.style.display = "none";
      }, 5000);
    }

    function showInfoMicro(message, autoHide = true) {
      const box = document.getElementById("infoMicro");
      const text = document.getElementById("infoMicroText");
      if (!box || !text) return;

      text.textContent = message;
      box.classList.remove("hide");
      box.classList.add("show");

      if (autoHide) {
        clearTimeout(box._hideTimer);
        box._hideTimer = setTimeout(() => {
          box.classList.remove("show");
          box.classList.add("hide");
        }, 4200);
      }
    }

    const radiusPopup = document.getElementById("radiusPopup");

    window.addEventListener("openRangePopup", () => {
      if (!radiusPopup) return;
      radiusPopup.style.display = "block";
    });

    if (radiusPopup) {
      radiusPopup.addEventListener("click", (e) => {
        const radius = e.target.dataset.radius;
        if (!radius) return;

        radiusPopup.style.display = "none";
        fetchNearbySpots(Number(radius));
      });
    }

    function getDistanceMiles(aLat, aLng, bLat, bLng) {
      const R = 3958.8;
      const dLat = (bLat - aLat) * Math.PI / 180;
      const dLng = (bLng - aLng) * Math.PI / 180;

      const a =
        Math.sin(dLat / 2) ** 2 +
        Math.cos(aLat * Math.PI / 180) *
        Math.cos(bLat * Math.PI / 180) *
        Math.sin(dLng / 2) ** 2;

      return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a)));
    }

    function updateInfoText(count, radiusMiles, isFallback) {
      const infoText = document.getElementById("infoTextUser");
      infoText.textContent = isFallback
        ? `Displaying ${count} Open Spots`
        : count > 0
          ? `Displaying ${count} Open Spots within ${radiusMiles} miles of your location`
          : "Displaying 0 Open Spots";
    }

    function clearMarkers() {
      markers.forEach(marker => marker.setMap(null));
      markers.length = 0;
    }

    function showSpots(spots, isFallback = false) {
      clearSelected();
      clearMarkers();

      spots.forEach(spot => {
        addMarker({
          lat: spot.lat,
          lng: spot.lng,
          available: true,
          meta: spot.meta || spot
        });
      });

      updateInfoText(spots.length, currentRadiusMiles, isFallback);
    }

    function panToSpots(spots) {
      const bounds = new google.maps.LatLngBounds();
      spots.forEach(spot => {
        bounds.extend({ lat: spot.lat, lng: spot.lng });
      });
      if (!bounds.isEmpty()) {
        map.fitBounds(bounds);
      }
    }

    async function showRiverOaksFallback() {
      const riverOaksCenter = { lat: 29.7394, lng: -95.4639 };

      map.panTo(riverOaksCenter);
      map.setZoom(13);

      const riverOaksSpots = [];
      const collections = ["private_metered_parking", "city_parking"];

      for (const col of collections) {
        const snap = await getDocs(collection(db, col));
        snap.forEach(doc => {
          const d = doc.data();
          if (!d.location_name) return;
          if (!d.location_name.toLowerCase().includes("river oaks")) return;

          let lat, lng;

          // Firestore GeoPoint (FlutterFlow default)
          if (d.geo?.latitude != null && d.geo?.longitude != null) {
            lat = d.geo.latitude;
            lng = d.geo.longitude;
          }

          // Backward compatibility (optional, safe)
          else if (d.lat != null && d.lng != null) {
            lat = Number(d.lat);
            lng = Number(d.lng);
          }

          if (Number.isNaN(lat) || Number.isNaN(lng)) return;

          riverOaksSpots.push({ ...d, id: doc.id, lat, lng });
        });
      }

      showSpots(riverOaksSpots, true);
      showInfoMicro(`0 Open Spots found within ${currentRadiusMiles} miles of your location. Showing River Oaks Mall parking.`);
      panToSpots(riverOaksSpots);
    }

    async function fetchNearbySpots(radiusMiles) {
      if (!userLatLng) return;
      currentRadiusMiles = radiusMiles;

      const results = [];
      const collections = ["private_metered_parking", "city_parking"];

      for (const col of collections) {
        const snap = await getDocs(collection(db, col));
        snap.forEach(doc => {
          const d = doc.data();

          let lat, lng;

          // Firestore GeoPoint (FlutterFlow default)
          if (d.geo?.latitude != null && d.geo?.longitude != null) {
            lat = d.geo.latitude;
            lng = d.geo.longitude;
          }

          // Backward compatibility (optional, safe)
          else if (d.lat != null && d.lng != null) {
            lat = Number(d.lat);
            lng = Number(d.lng);
          }

          if (Number.isNaN(lat) || Number.isNaN(lng)) return;

          const distance = getDistanceMiles(
            userLatLng.lat,
            userLatLng.lng,
            lat,
            lng
          );

          const isAvailable = d.is_available !== false;

          if (distance <= radiusMiles && isAvailable) {
            results.push({ ...d, id: doc.id, lat, lng });
          }
        });
      }

      if (results.length) {
        showSpots(results, false);
        panToSpots(results);
      } else {
        await showRiverOaksFallback();
      }
    }

    function addMarker(spot) {
      const isAvailable = spot.available !== false;
      const marker = new google.maps.Marker({
        position: { lat: spot.lat, lng: spot.lng },
        map: map,
        icon: {
          url: isAvailable ? AVAILABLE_ICON : OCCUPIED_ICON,
          scaledSize: new google.maps.Size(30.6, 64.80)
        }
      });

      marker.spot = spot;
      markers.push(marker);

      marker.addListener("click", () => {
        if (window.hideNearbyTip) {
          window.hideNearbyTip();
        }
        clearSelected();

        marker.setIcon({
          url: isAvailable ? AVAILABLE_ICON : OCCUPIED_ICON,
          scaledSize: new google.maps.Size(40, 70)
        });
        selectedMarker = marker;

        showSpotCard(spot);
      });
    }

    function showSpotCard(spot) {
      const card = document.getElementById("spotInfo");
      const title = document.getElementById("spotTitle");
      const details = document.getElementById("spotDetails");
      const navBtn = document.getElementById("navigateBtn");
      const meta = spot.meta || {};

      title.innerText = meta.location_name || "Parking Spot";
      details.innerHTML = `
        ${meta.zone_number ? `Zone ${meta.zone_number}<br>` : ""}
        ${meta.rate_per_hour != null ? `$${meta.rate_per_hour}/hr<br>` : ""}
        ${meta.max_duration_mins ? `${meta.max_duration_mins} min max` : ""}
      `;
      navBtn.innerText = "NAVIGATE";
      navBtn.className = "navigate-btn";
      navBtn.disabled = false;
      navBtn.onclick = () => openDirections(spot.lat, spot.lng);

      card.style.display = "block";
      card.classList.add("show");
    }

    function clearSelected() {
      if (selectedMarker) {
        const isAvailable = selectedMarker.spot.available !== false;
        selectedMarker.setIcon({
          url: isAvailable ? AVAILABLE_ICON : OCCUPIED_ICON,
          scaledSize: new google.maps.Size(30.6, 64.80)
        });
        selectedMarker = null;
      }
      if (selectedPulse) {
        selectedPulse.setMap(null);
        selectedPulse = null;
      }
      document.getElementById("spotInfo").classList.remove("show");
    }

    function startPulse(map, position) {
      const pulse = new google.maps.Circle({
        map,
        center: position,
        radius: 0,
        strokeOpacity: 0,
        fillColor: "#3b82f6",
        fillOpacity: 0.35,
        clickable: false
      });

      let radius = 0;
      let growing = true;
      setInterval(() => {
        radius = growing ? radius + 6 : 0;
        pulse.setRadius(radius);
        if (radius >= 120) growing = false;
        if (!growing && radius === 0) growing = true;
      }, 60);

      return pulse;
    }

    function getUserLocation(callback) {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          pos => {
            userLatLng = {
              lat: pos.coords.latitude,
              lng: pos.coords.longitude
            };
            showNavHint();
            callback(pos.coords.latitude, pos.coords.longitude);
          },
          () => {
            userLatLng = { lat: 29.76295, lng: -95.36225 };
            callback(29.76295, -95.36225);
          }
        );
        return;
      }

      userLatLng = { lat: 29.76295, lng: -95.36225 };
      callback(29.76295, -95.36225);
    }

    function updateUserLocation(lat, lng) {
      if (!map || !userMarker || !userPulse) {
        return;
      }

      const newPos = { lat, lng };
      map.setCenter(newPos);
      userMarker.setPosition(newPos);
      userPulse.setCenter(newPos);
      userMarker.setAnimation(google.maps.Animation.BOUNCE);
      setTimeout(() => userMarker.setAnimation(null), 1200);
    }

    // -------------------------------
    // Initialize map
    // -------------------------------
    function initMap(userLat,userLng,radius){
      if(userLat===undefined||userLng===undefined||radius===undefined){return;}
      map=new google.maps.Map(document.getElementById("map"),{
        center:{lat:userLat,lng:userLng},zoom:15,mapTypeControl:true,mapTypeId:"satellite",tilt:0,
        streetViewControl:false,fullscreenControl:false
      });
      window.map = map;

      userMarker=new google.maps.Marker({
        position:{lat:userLat,lng:userLng},map,title:"You are here",
        icon:{path:google.maps.SymbolPath.CIRCLE,fillColor:"#007bff",fillOpacity:0.9,
              strokeColor:"#fff",strokeWeight:2,scale:8}
      });
      userMarker.setAnimation(google.maps.Animation.BOUNCE);
      setTimeout(()=>userMarker.setAnimation(null),1200);
      const pulse=startPulse(map,{lat:userLat,lng:userLng});
      userPulse = pulse;

      // üìç Locate button
      const locationButton=document.createElement("button");
      locationButton.textContent="üìç";
      locationButton.classList.add("locate-btn");
      map.controls[google.maps.ControlPosition.RIGHT_BOTTOM].push(locationButton);
      locationButton.addEventListener("click",()=>{
        if(navigator.geolocation){
          navigator.geolocation.getCurrentPosition(pos=>{
            const newPos={lat:pos.coords.latitude,lng:pos.coords.longitude};
            currentUserLat = newPos.lat;
            currentUserLng = newPos.lng;
            userLatLng = newPos;
            map.setCenter(newPos);
            userMarker.setPosition(newPos);
            pulse.setCenter(newPos);
            userMarker.setAnimation(google.maps.Animation.BOUNCE);
            setTimeout(()=>userMarker.setAnimation(null),1200);
          });
        }else alert("Geolocation not supported by your browser.");
      });

      map.addListener("click", () => {
        clearSelected();
        document.getElementById("spotInfo").classList.remove("show");

        if (window.hideNearbyTip) window.hideNearbyTip();
      });
    }

    // --- MAIN ---
    const params=new URLSearchParams(location.search);
    const radius=parseFloat(params.get("radius"))||3;
    currentRadiusMiles = radius;


    function bootNearbyMap() {
      if (!window.google || !window.google.maps) {
        setTimeout(bootNearbyMap, 100);
        return;
      }

      if (!currentRadiusMiles) currentRadiusMiles = 3;

      initMap(29.76295, -95.36225, currentRadiusMiles);

      getUserLocation((lat, lng) => {
        currentUserLat = lat;
        currentUserLng = lng;
        updateUserLocation(lat, lng);
      });
    }

    document.addEventListener("DOMContentLoaded", bootNearbyMap);
  </script>
</body>
</html>
