<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Attendant Console | OpenSpots</title>
  <link rel="icon" type="image/png" href="assets/Facebook Profile Picture.png" />

  <link rel="stylesheet" href="attendant.css" />
</head>
<body>

<header class="attendant-header">
  <h1>Attendant Console</h1>
  <select id="venueSelect">
    <option value="">Select Venue</option>
  </select>
</header>

<main>
  <section class="legend">
    <span class="badge confirmed">Confirmed</span>
    <span class="badge arrived">Arrived</span>
    <span class="badge expired">Expired</span>
    <span class="badge invalid">Invalid</span>
  </section>

  <section id="reservationsList">
    <p class="loading">Loading reservationsâ€¦</p>
  </section>
</main>

<script type="module">
  import { getAuth, onAuthStateChanged } from
    "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";
  import {
    collection,
    doc,
    getDocs,
    query,
    where
  } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";
  import { app, db } from "./firebase-init.js";

  const auth = getAuth(app);

  function redirectToLogin() {
    window.location.href = "/login.html";
  }

  async function getOperatorByUserId(userId) {
    const q = query(
      collection(db, "operators"),
      where("user_id", "==", doc(db, "users", userId)),
      where("is_active", "==", true)
    );

    const snap = await getDocs(q);
    return snap.empty ? null : snap.docs[0].data();
  }

  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      redirectToLogin();
      return;
    }

    const operatorDoc = await getOperatorByUserId(user.uid);

    if (!operatorDoc || !operatorDoc.is_active) {
      window.location.href = "/nearby.html";
    }
  });
</script>
<script type="module" src="attendant.js"></script>
</body>
</html>
