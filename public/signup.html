<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<title>OpenSpots | Sign Up</title>

    <!-- Favicon -->
    <link rel="icon" type="image/png" href="assets/Facebook Profile Picture.png" />

    <!-- Styles -->
    <link rel="stylesheet" href="style.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>

  <script type="module">
    import { getAuth, createUserWithEmailAndPassword, sendEmailVerification } from
      "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";
    import { doc, setDoc, serverTimestamp } from
      "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";
    import { app, db } from "./firebase-init.js";

    const auth = getAuth(app);

    document.addEventListener("DOMContentLoaded", () => {
      const signupForm = document.getElementById("signupForm");
      if (!signupForm) return;

      const params = new URLSearchParams(window.location.search);
      const spot = params.get("spot");

      signupForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        e.stopImmediatePropagation();

        const firstName = document.getElementById("firstName").value.trim();
        const lastName = document.getElementById("lastName").value.trim();
        const email = document.getElementById("email").value.trim();
        const password = document.getElementById("password").value.trim();
        const confirm = document.getElementById("confirm").value.trim();
        const errorBox = document.getElementById("error-message");

        if (password !== confirm) {
          errorBox.style.display = "block";
          errorBox.textContent = "Passwords do not match.";
          return;
        }

        try {
          const { user } = await createUserWithEmailAndPassword(auth, email, password);
          await sendEmailVerification(user);

          await setDoc(doc(db, "users", user.uid), {
            uid: user.uid,
            email: user.email,
            first_name: firstName,
            last_name: lastName,
            display_name: `${firstName} ${lastName}`,
            created_time: serverTimestamp(),
            setupComplete: false
          });

          window.location.href = spot
            ? `accSetup.html?spot=${encodeURIComponent(spot)}`
            : "accSetup.html";
        } catch (err) {
          errorBox.style.display = "block";
          errorBox.textContent = "Account could not be created.";
        }
      });

      const toggles = document.querySelectorAll(".toggle-password");
      toggles.forEach((toggle) => {
        toggle.addEventListener("click", () => {
          const targetId = toggle.getAttribute("data-target");
          const passwordEl = targetId
            ? document.getElementById(targetId)
            : null;
          if (!passwordEl) return;

          const isPassword = passwordEl.type === "password";
          passwordEl.type = isPassword ? "text" : "password";
          toggle.classList.toggle("fa-eye");
          toggle.classList.toggle("fa-eye-slash");
        });
      });
    });
  </script>
</head>

<body class="login-bg">

    <div class="signup-container">

        <!-- Logo -->
        <img src="assets/Facebook Profile Picture.png" class="signup-logo" alt="OpenSpots Logo">

        <!-- Title -->
        <div class="signup-title">
        <span>WELCOME TO</span>
        <span class="signup-title-bold">OPENSPOTS</span>
        </div>

        <form id="signupForm">

            <div id="error-message"
                 style="display:none; margin-bottom: 10px; color:#ffebee; background:#b71c1c; padding:10px; border-radius:8px; margin-top:10px; font-size:14px; text-align:center;">
            </div>

            <input id="firstName" name="first_name" type="text" class="login-input" placeholder="First Name" required />
            <input id="lastName" name="last_name" type="text" class="login-input" placeholder="Last Name" required />
            <input id="email" type="email" class="login-input" placeholder="Please Enter Your Email" required />
            <div class="password-field">
                <input id="password" type="password" class="login-input pass" placeholder="Create a Password" required />
                <i class="fa-regular fa-eye toggle-password" data-target="password"></i>
            </div>
            <div class="password-field">
                <input id="confirm" type="password" class="login-input pass" placeholder="Confirm Password" required />
                <i class="fa-regular fa-eye toggle-password" data-target="confirm"></i>
            </div>

            <button type="submit" class="login-btn">CREATE ACCOUNT</button>

        </form>

        <div class="signup-link">
            Already have an account? <a href="login.html">Login</a>
        </div>
    </div>
</body>
</html>
