<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<title>Checkout | OpenSpots</title>
  <link rel="icon" type="image/png" href="assets/Facebook Profile Picture.png" />
  <link rel="stylesheet" href="checkout.css" />
  <script src="https://js.stripe.com/v3/"></script>
</head>

<body>
  <!-- HEADER -->
  <header class="checkout-header">
    <button class="back-btn" onclick="window.history.back()">← Back</button>
    <img src="assets/Facebook Profile Picture.png" alt="OpenSpots Logo" class="header-logo" />
  </header>

  <!-- MAIN -->
  <main class="checkout-container">
    <h1>Checkout</h1>

    <section class="summary-card">
      <h2>Reservation Summary</h2>
      <div class="summary-grid" id="summary-grid"></div>
    </section>

    <button id="payNowBtn" class="btn-primary">Pay Now</button>
  </main>

  <footer class="checkout-footer">© 2025 OpenSpots</footer>

  <script type="module">
    import { db, auth } from "./firebase-init.js";
    import {
      doc,
      getDoc
    } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";

    // Parse URL params
    const params = new URLSearchParams(window.location.search);
    const eventId = params.get("event");
    const spotId = params.get("spot");
    const venueId = params.get("venue");
    const flow = params.get("flow");
    const isPrivateVenue = !eventId;

    // normalize price
    const rawPrice = params.get("price");
    const price = Number(rawPrice);
    const finalPrice = Number.isFinite(price) && price > 0 ? price : 25;

    window.selectedEventId = eventId;
    window.selectedSpotId = spotId;
    window.selectedPrice = finalPrice;

    // Retrieve reservation info from details.html (if any)
    const data = JSON.parse(sessionStorage.getItem('openspotsReservation') || '{}');
    const meta = JSON.parse(sessionStorage.getItem('openspotsReservationMeta') || '{}');

    const looksLikeId = (value) =>
      typeof value === "string" && value.trim().length >= 6 && !/\s/.test(value);

    let eventDisplay = meta.eventName || "-";

    // Resolve EVENT name for event venues
    if (!isPrivateVenue && eventId) {
      try {
        const eventSnap = await getDoc(doc(db, "events", eventId));
        if (eventSnap.exists()) {
          const eventData = eventSnap.data();
          eventDisplay =
            eventData.name ||
            eventData.event_name ||
            eventData.title ||
            "-";
        }
      } catch (err) {
        console.error("Failed to load event name", err);
        eventDisplay = "-";
      }
    }
    let spotDisplay = "-";

    if (isPrivateVenue) {
      try {
        const spotSnap = await getDoc(doc(db, "spots", spotId));
        if (spotSnap.exists()) {
          const spotData = spotSnap.data();
          spotDisplay = spotData.spot_id || spotData.name || "-";
        } else {
          spotDisplay = "-";
        }
      } catch (err) {
        console.error("Failed to load private spot", err);
        spotDisplay = "-";
      }
    } else {
      // ✅ EVENT VENUE → resolve via Firestore
      try {
        const spotSnap = await getDoc(doc(db, "spots", spotId));
        if (spotSnap.exists()) {
          const spotData = spotSnap.data();
          spotDisplay = spotData.spot_id || spotData.name || spotId;
        }
      } catch (err) {
        console.error("Failed to load event spot", err);
      }
    }

    function getOrCreateGuestId() {
      let id = localStorage.getItem("openspotsGuestId");
      if (!id) {
        id = `guest_${crypto.randomUUID()}`;
        localStorage.setItem("openspotsGuestId", id);
      }
      return id;
    }

    async function resolveUserData() {
      // 1️⃣ Check if user is logged in
      return new Promise((resolve) => {
        onAuthStateChanged(auth, async (user) => {
          if (user) {
            // Logged-in user → fetch Firestore profile
            try {
              const snap = await getDoc(doc(db, "users", user.uid));
              window.currentUserId = user.uid;
              if (snap.exists()) {
                const userData = snap.data();
                const normalizedUser = {
                  firstName: userData.display_name || "-",
                  lastName: userData.last_name || "-",
                  email: userData.email || "-",
                  phone: userData.phone_number || "-",
                  vehicle: userData.vehicle_make_model || "-",
                  plate: userData.vehicle_license || "-"
                };

                resolve({ source: "auth", ...normalizedUser });
              } else {
                resolve({ source: "auth" });
              }
            } catch (e) {
              console.error("User fetch failed", e);
              resolve({});
            }
          } else {
            window.currentUserId = getOrCreateGuestId();
            // Free user → sessionStorage
            const data =
              JSON.parse(sessionStorage.getItem("openspotsReservation") || "{}");
            resolve({ source: "guest", ...data });
          }
        });
      });
    }

    const summary = document.getElementById('summary-grid');
    const normalizedUser = await resolveUserData();
    summary.innerHTML = `
      <div><strong>First Name:</strong> ${normalizedUser.firstName || "-"}</div>
      <div><strong>Last Name:</strong> ${normalizedUser.lastName || "-"}</div>
      <div><strong>Email:</strong> ${normalizedUser.email || "-"}</div>
      <div><strong>Phone:</strong> ${normalizedUser.phone || "-"}</div>
      <div><strong>Vehicle:</strong> ${normalizedUser.vehicle || "-"}</div>
      <div><strong>License Plate:</strong> ${normalizedUser.plate || "-"}</div>

      ${
        !isPrivateVenue
          ? `<div><strong>Event:</strong> ${eventDisplay || "-"}</div>`
          : ""
      }

      <div><strong>Spot:</strong> ${spotDisplay || "-"}</div>
      <div><strong>Price:</strong> $${finalPrice}</div>
    `;

    // Stripe init (ready for backend step)
    const stripe = Stripe("pk_test_51ShIrzDMJJmdLkf9RMOjnKPKzC9zfc8KzCuU1IwJC9OMANvShxeKd4EiK7g7qehKw041Dd78jXbG8qRnARMd6AKD00E30da1ki");

    document.getElementById("payNowBtn").addEventListener("click", async () => {
      if (!window.selectedEventId || !window.selectedSpotId) {
        alert("Missing event or spot. Please go back and select again.");
        return;
      }

      if (!window.currentUserId) {
        alert("Missing user id. Please refresh and try again.");
        return;
      }

      try {
        const response = await fetch("/create-checkout-session", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            eventId: window.selectedEventId,
            spotId: window.selectedSpotId,
            price: window.selectedPrice,   // ✅ send the normalized price
            userId: window.currentUserId,  // ✅ never null now (auth uid or guest_ uuid)
            flow: flow || null
          })
        });

        const data = await response.json();

        if (!data.sessionId) {
          alert("Failed to start checkout");
          return;
        }

        await stripe.redirectToCheckout({
          sessionId: data.sessionId
        });

      } catch (err) {
        console.error("Checkout error:", err);
        alert("Something went wrong. Please try again.");
      }
    });
  </script>
</body>
</html>
